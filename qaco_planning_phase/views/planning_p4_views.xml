<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================== -->
    <!-- P-4: Preliminary Analytical Review            -->
    <!-- ISA 520                                        -->
    <!-- ============================================== -->

    <!-- P-4 Form View -->
    <record id="view_planning_p4_analytics_form" model="ir.ui.view">
        <field name="name">qaco.planning.p4.analytics.form</field>
        <field name="model">qaco.planning.p4.analytics</field>
        <field name="arch" type="xml">
            <form string="P-4: Risk Identification &amp; Assessment (FS Level)">
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="not_started,in_progress,completed,reviewed,approved"/>
                    <button name="action_start_work" string="Start Work" type="object" class="btn-primary"
                            invisible="state != 'not_started'"/>
                    <button name="action_complete" string="Mark Complete" type="object" class="btn-primary"
                            invisible="state != 'in_progress'"/>
                    <button name="action_review" string="Manager Review" type="object" class="btn-warning"
                            invisible="state != 'completed'" groups="qaco_audit.group_audit_manager"/>
                    <button name="action_approve" string="Partner Approve" type="object" class="btn-success"
                            invisible="state != 'reviewed'" groups="qaco_audit.group_audit_partner"/>
                    <button name="action_send_back" string="Send Back" type="object" class="btn-secondary"
                            invisible="state not in ['completed', 'reviewed']"/>
                    <button name="action_unlock" string="Unlock" type="object" class="btn-danger"
                            invisible="state != 'approved'" groups="qaco_audit.group_audit_partner"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                        <h3 class="text-muted">ISA 315 | Risk Identification &amp; Assessment (Financial Statement Level)</h3>
                    </div>
                    <group>
                        <group string="Audit Information">
                            <field name="audit_id" readonly="state != 'not_started'"/>
                            <field name="client_id"/>
                        </group>
                        <group string="Financial Year">
                            <field name="current_year_end"/>
                            <field name="prior_year_end"/>
                        </group>
                    </group>

                    <notebook>
                        <!-- Tab 1: Financial Highlights -->
                        <page string="Financial Highlights" name="highlights">
                            <group string="Current Year Figures">
                                <group>
                                    <field name="current_total_assets"/>
                                    <field name="current_total_liabilities"/>
                                    <field name="current_equity"/>
                                </group>
                                <group>
                                    <field name="current_revenue"/>
                                    <field name="current_cost_of_sales"/>
                                    <field name="current_gross_profit"/>
                                </group>
                            </group>
                            <group string="Prior Year Figures">
                                <group>
                                    <field name="prior_total_assets"/>
                                    <field name="prior_total_liabilities"/>
                                    <field name="prior_equity"/>
                                </group>
                                <group>
                                    <field name="prior_revenue"/>
                                    <field name="prior_cost_of_sales"/>
                                    <field name="prior_gross_profit"/>
                                </group>
                            </group>
                        </page>

                        <!-- Tab 2: Trend Analysis -->
                        <page string="Trend Analysis" name="trends">
                            <group string="Year-over-Year Changes">
                                <group>
                                    <field name="revenue_change_pct"/>
                                    <field name="asset_change_pct"/>
                                    <field name="equity_change_pct"/>
                                </group>
                                <group>
                                    <field name="profit_change_pct"/>
                                    <field name="liability_change_pct"/>
                                </group>
                            </group>
                            <group string="Trend Analysis Narrative">
                                <field name="trend_analysis" widget="html" nolabel="1"/>
                            </group>
                            <group string="Trend Observations">
                                <field name="trend_observations" widget="html" nolabel="1"/>
                            </group>
                        </page>

                        <!-- Tab 3: Ratio Analysis -->
                        <page string="Ratio Analysis" name="ratios">
                            <group string="Liquidity Ratios">
                                <group>
                                    <field name="current_ratio"/>
                                    <field name="quick_ratio"/>
                                    <field name="cash_ratio"/>
                                </group>
                                <group>
                                    <field name="working_capital"/>
                                </group>
                            </group>
                            <group string="Profitability Ratios">
                                <group>
                                    <field name="gross_margin_pct"/>
                                    <field name="net_margin_pct"/>
                                    <field name="return_on_assets"/>
                                </group>
                                <group>
                                    <field name="return_on_equity"/>
                                </group>
                            </group>
                            <group string="Leverage Ratios">
                                <group>
                                    <field name="debt_to_equity"/>
                                    <field name="debt_ratio"/>
                                    <field name="interest_coverage"/>
                                </group>
                            </group>
                            <group string="Efficiency Ratios">
                                <group>
                                    <field name="inventory_turnover"/>
                                    <field name="receivable_days"/>
                                    <field name="payable_days"/>
                                </group>
                                <group>
                                    <field name="asset_turnover"/>
                                </group>
                            </group>
                        </page>

                        <!-- Tab 4: Industry Comparison -->
                        <page string="Industry Comparison" name="industry">
                            <group string="Industry Benchmarks">
                                <field name="industry_benchmark" widget="html" nolabel="1"/>
                            </group>
                            <group string="Peer Comparison">
                                <field name="peer_comparison" widget="html" nolabel="1"/>
                            </group>
                            <group string="Deviations from Industry Norms">
                                <field name="industry_deviations" widget="html" nolabel="1"/>
                            </group>
                        </page>

                        <!-- Tab 5: Anomaly Identification -->
                        <page string="Anomalies" name="anomalies">
                            <group string="Anomalies &amp; Unusual Items">
                                <field name="anomalies_identified" widget="html" nolabel="1"/>
                            </group>
                            <group string="Significant Fluctuations">
                                <field name="significant_fluctuations" widget="html" nolabel="1"/>
                            </group>
                            <group string="Fraud Indicators">
                                <field name="fraud_indicators" widget="html" nolabel="1"/>
                            </group>
                            <group string="Audit Focus Areas Identified">
                                <field name="audit_focus_areas" widget="html" nolabel="1"/>
                            </group>
                        </page>

                        <!-- Tab 6: Management Inquiry -->
                        <page string="Management Inquiry" name="inquiry">
                            <group string="Management Explanations">
                                <field name="management_explanations" widget="html" nolabel="1"/>
                            </group>
                            <group string="Questions for Management">
                                <field name="management_questions" widget="html" nolabel="1"/>
                            </group>
                            <group string="Responses Received">
                                <field name="responses_received" widget="html" nolabel="1"/>
                            </group>
                        </page>

                        <!-- Tab 7: Attachments -->
                        <page string="Attachments" name="attachments">
                            <group string="Financial Statements">
                                <field name="financial_statement_ids" widget="many2many_binary" nolabel="1"/>
                            </group>
                            <group string="Trial Balance">
                                <field name="trial_balance_ids" widget="many2many_binary" nolabel="1"/>
                            </group>
                            <group string="Supporting Analysis">
                                <field name="analysis_attachment_ids" widget="many2many_binary" nolabel="1"/>
                            </group>
                        </page>

                        <!-- Tab 8: Conclusion & Sign-off -->
                        <page string="Conclusion &amp; Sign-off" name="conclusion">
                            <group string="Analytical Review Conclusion">
                                <field name="analytics_conclusion" widget="html" nolabel="1"/>
                            </group>
                            <group string="Impact on Audit Plan">
                                <field name="impact_on_audit_plan" widget="html" nolabel="1"/>
                            </group>
                            <group>
                                <group string="Sign-off">
                                    <field name="senior_signed_user_id"/>
                                    <field name="senior_signed_on"/>
                                    <field name="manager_reviewed_user_id"/>
                                    <field name="manager_reviewed_on"/>
                                    <field name="partner_approved_user_id"/>
                                    <field name="partner_approved_on"/>
                                </group>
                                <group string="ISA Reference">
                                    <field name="isa_reference"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- P-4 Tree View -->
    <record id="view_planning_p4_analytics_tree" model="ir.ui.view">
        <field name="name">qaco.planning.p4.analytics.tree</field>
        <field name="model">qaco.planning.p4.analytics</field>
        <field name="arch" type="xml">
            <tree string="P-4: Analytics">
                <field name="name"/>
                <field name="client_id"/>
                <field name="current_revenue"/>
                <field name="revenue_change_pct"/>
                <field name="state" widget="badge" decoration-info="state == 'not_started'"
                       decoration-warning="state == 'in_progress'" decoration-success="state == 'approved'"/>
            </tree>
        </field>
    </record>

    <!-- P-4 Action -->
    <record id="action_planning_p4_analytics" model="ir.actions.act_window">
        <field name="name">P-4: Risk Identification &amp; Assessment (FS Level)</field>
        <field name="res_model">qaco.planning.p4.analytics</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create P-4 Risk Identification &amp; Assessment (Financial Statement Level)
            </p>
            <p>
                Document risk identification and assessment at financial statement level per ISA 315.
            </p>
        </field>
    </record>

</odoo>
