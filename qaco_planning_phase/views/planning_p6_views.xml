<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================== -->
    <!-- P-6: Risk Assessment (RMM)                    -->
    <!-- ISA 315/330/240/570                            -->
    <!-- ============================================== -->

    <!-- P-6 Form View -->
    <record id="view_planning_p6_risk_form" model="ir.ui.view">
        <field name="name">qaco.planning.p6.risk.form</field>
        <field name="model">qaco.planning.p6.risk</field>
        <field name="arch" type="xml">
            <form string="P-6: Risk Assessment (RMM)">
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="draft,prepared,reviewed,locked"/>
                    <button name="action_prepare" string="Mark Prepared" type="object" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_review" string="Manager Review" type="object" class="btn-warning"
                            invisible="state != 'prepared'" groups="qaco_audit.group_audit_manager"/>
                    <button name="action_partner_approve" string="Partner Approve" type="object" class="btn-success"
                            invisible="state != 'reviewed'" groups="qaco_audit.group_audit_partner"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>P-6: Risk Assessment (RMM)</h1>
                        <h3 class="text-muted">ISA 315 | Identifying and Assessing Risks of Material Misstatement</h3>
                    </div>
                    <group>
                        <group string="Audit Information">
                            <field name="engagement_id" readonly="state == 'locked'"/>
                            <field name="audit_year" readonly="state == 'locked'"/>
                            <field name="partner_id" readonly="state == 'locked'"/>
                        </group>
                        <group string="Status">
                            <field name="locked"/>
                            <field name="partner_approved"/>
                        </group>
                    </group>

                    <notebook>
                        <!-- Section A: Risk Identification Sources -->
                        <page string="A: Risk Sources" name="risk_sources">
                            <group string="System-Generated Sources (Auto-Display)">
                                <group>
                                    <field name="sources_entity"/>
                                    <field name="sources_controls"/>
                                    <field name="sources_analytics"/>
                                    <field name="sources_materiality"/>
                                    <field name="sources_prior_year"/>
                                    <field name="sources_fraud_brainstorm"/>
                                </group>
                            </group>
                            <group string="Checklists">
                                <field name="sources_checklist"/>
                                <field name="sources_no_isolation"/>
                            </group>
                        </page>

                        <!-- Section B: Financial Statement Level Risks -->
                        <page string="B: FS Level Risks" name="fs_risks">
                            <group string="Financial Statement Level Risk Description">
                                <field name="fs_level_risk_desc" nolabel="1" placeholder="Describe pervasive risks affecting the financial statements as a whole..."/>
                            </group>
                            <group>
                                <group string="Risk Characteristics">
                                    <field name="fs_level_risk_nature"/>
                                    <field name="fs_level_pervasive"/>
                                    <field name="fs_level_severity"/>
                                </group>
                                <group string="Impact">
                                    <field name="fs_level_areas"/>
                                </group>
                            </group>
                            <group string="Checklists">
                                <field name="fs_level_checklist"/>
                                <field name="fs_level_impact_checklist"/>
                            </group>
                        </page>

                        <!-- Section C: Assertion Level Risks (Risk Register) -->
                        <page string="C: Risk Register" name="risk_register">
                            <group string="Assertion-Level Risk Register (Core Engine)">
                                <field name="risk_line_ids" nolabel="1">
                                    <tree editable="bottom" decoration-danger="risk_rating == 'high'" decoration-warning="risk_rating == 'medium'">
                                        <field name="sequence" widget="handle"/>
                                        <field name="account_cycle"/>
                                        <field name="assertion_type"/>
                                        <field name="risk_description"/>
                                        <field name="inherent_risk"/>
                                        <field name="control_risk"/>
                                        <field name="risk_rating"/>
                                        <field name="is_significant_risk"/>
                                        <field name="isa_240_fraud_risk"/>
                                        <field name="planned_procedures"/>
                                    </tree>
                                </field>
                            </group>
                        </page>
                        
                        <!-- Section D: Significant Risks -->
                        <page string="D: Significant Risks" name="significant_risks">
                            <group string="Significant Risks Overview">
                                <field name="significant_risks_count"/>
                            </group>
                            <group string="Significant Risks Detail (Filtered from Risk Register)">
                                <p class="text-muted">
                                    Significant risks are those requiring special audit consideration. 
                                    For each significant risk, document basis for classification and planned response.
                                </p>
                            </group>
                        </page>
                        
                        <!-- Section E: Fraud Risks -->
                        <page string="E: Fraud Risks" name="fraud_risks">
                            <group string="Fraud Risks Overview">
                                <field name="fraud_risks_count"/>
                            </group>
                            <group string="ISA 240 Fraud Risk Integration">
                                <p class="text-muted">
                                    Fraud risks identified in the risk register will auto-flow to P-7 (Fraud Risk Assessment).
                                    Revenue recognition and management override are presumed fraud risks.
                                </p>
                            </group>
                        </page>
                        
                        <!-- Section I: Heat Map & Dashboard -->
                        <page string="I: Heat Map" name="heat_map">
                            <group string="Risk Distribution Summary">
                                <group>
                                    <field name="total_risks_count"/>
                                    <field name="high_risk_count"/>
                                    <field name="medium_risk_count"/>
                                    <field name="low_risk_count"/>
                                </group>
                                <group>
                                    <field name="significant_risks_count"/>
                                    <field name="fraud_risks_count"/>
                                </group>
                            </group>
                            <group string="Risk Distribution by Account Cycle">
                                <field name="risks_by_account_cycle" readonly="1"/>
                            </group>
                            <group string="Risk Distribution by Assertion">
                                <field name="risks_by_assertion" readonly="1"/>
                            </group>
                        </page>


                        <!-- Section J: Mandatory Document Uploads -->
                        <page string="J: Documents" name="documents">
                            <group string="Required Attachments">
                                <field name="attachment_ids" widget="many2many_binary" nolabel="1"/>
                                <field name="mandatory_upload_check"/>
                            </group>
                        </page>

                        <!-- Section K: Conclusion & Professional Judgment -->
                        <page string="K: Conclusion" name="conclusion">
                            <group string="P-6 Conclusion Narrative">
                                <field name="conclusion_narrative" nolabel="1" placeholder="Document overall risk assessment conclusion..."/>
                            </group>
                            <group string="Final Confirmations">
                                <field name="significant_risks_confirmed"/>
                                <field name="rmm_assessed_confirmed"/>
                                <field name="audit_response_basis_confirmed"/>
                            </group>
                        </page>

                        <!-- Section L: Review, Approval & Lock -->
                        <page string="L: Review &amp; Approval" name="review">
                            <group string="Prepared By">
                                <group>
                                    <field name="prepared_by"/>
                                    <field name="prepared_by_role"/>
                                    <field name="prepared_date"/>
                                </group>
                            </group>
                            <group string="Reviewed By (Manager)">
                                <group>
                                    <field name="reviewed_by"/>
                                    <field name="review_notes" nolabel="1" placeholder="Manager review notes..."/>
                                </group>
                            </group>
                            <group string="Partner Approval">
                                <group>
                                    <field name="partner_approved"/>
                                    <field name="partner_comments" nolabel="1" placeholder="Partner comments (MANDATORY for approval)..."/>
                                </group>
                            </group>
                            <group string="Audit Trail">
                                <field name="version_history"/>
                                <field name="reviewer_timestamps"/>
                            </group>
                        </page>

                        <!-- Outputs -->
                        <page string="Outputs" name="outputs">
                            <group string="Auto-Generated Documents">
                                <field name="risk_memo_pdf" filename="risk_memo.pdf"/>
                                <field name="risk_heat_map" filename="risk_heat_map.png"/>
                                <field name="risk_register_export" filename="risk_register.xlsx"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- P-6 Tree View -->
    <record id="view_planning_p6_risk_tree" model="ir.ui.view">
        <field name="name">qaco.planning.p6.risk.tree</field>
        <field name="model">qaco.planning.p6.risk</field>
        <field name="arch" type="xml">
            <tree string="P-6: Risk Assessment">
                <field name="engagement_id"/>
                <field name="audit_year"/>
                <field name="state" widget="badge" decoration-info="state == 'draft'"
                       decoration-warning="state in ['prepared', 'reviewed']" decoration-success="state == 'locked'"/>
                <field name="partner_approved"/>
            </tree>
        </field>
    </record>

    <!-- P-6 Action -->
    <record id="action_planning_p6_risk" model="ir.actions.act_window">
        <field name="name">P-6: Risk Assessment (RMM)</field>
        <field name="res_model">qaco.planning.p6.risk</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create P-6 Risk Assessment (RMM)
            </p>
            <p>
                Identify and assess risks of material misstatement per ISA 315.
            </p>
        </field>
    </record>

    <!-- Risk Register Line Model Views -->
    <record id="view_risk_register_line_tree" model="ir.ui.view">
        <field name="name">qaco.planning.p6.risk.line.tree</field>
        <field name="model">qaco.planning.p6.risk.line</field>
        <field name="arch" type="xml">
            <tree string="Risk Register" editable="bottom" decoration-danger="risk_rating == 'high'" decoration-warning="risk_rating == 'medium'">
                <field name="sequence" widget="handle"/>
                <field name="account_cycle"/>
                <field name="assertion_type"/>
                <field name="risk_description"/>
                <field name="inherent_risk"/>
                <field name="control_risk"/>
                <field name="risk_rating"/>
                <field name="is_significant_risk"/>
                <field name="planned_procedures"/>
            </tree>
        </field>
    </record>

    <!-- Risk Register Line Form View -->
    <record id="view_risk_register_line_form" model="ir.ui.view">
        <field name="name">qaco.planning.p6.risk.line.form</field>
        <field name="model">qaco.planning.p6.risk.line</field>
        <field name="arch" type="xml">
            <form string="Risk Line">
                <sheet>
                    <group>
                        <group>
                            <field name="account_cycle"/>
                            <field name="assertion_type"/>
                            <field name="fs_level_risk"/>
                        </group>
                        <group>
                            <field name="inherent_risk"/>
                            <field name="control_risk"/>
                            <field name="risk_rating"/>
                            <field name="is_significant_risk"/>
                        </group>
                    </group>
                    <group string="Risk Description">
                        <field name="risk_description" nolabel="1" placeholder="Describe the specific risk..."/>
                    </group>
                    <group string="Risk Factors &amp; Analysis">
                        <field name="risk_factors" nolabel="1" placeholder="Factors contributing to this risk..."/>
                        <field name="root_cause" nolabel="1" placeholder="Root cause analysis..."/>
                        <field name="impact_on_fs" nolabel="1" placeholder="Impact on financial statements..."/>
                    </group>
                    <group>
                        <group string="Likelihood &amp; Magnitude">
                            <field name="likelihood"/>
                            <field name="magnitude"/>
                        </group>
                        <group string="ISA-Specific Flags">
                            <field name="isa_240_fraud_risk"/>
                            <field name="isa_540_estimate_risk"/>
                            <field name="isa_550_rp_risk"/>
                            <field name="isa_570_gc_risk"/>
                        </group>
                    </group>
                    
                    <!-- Section D: Significant Risk Details -->
                    <group string="Significant Risk Classification" invisible="not is_significant_risk">
                        <field name="basis_for_classification" nolabel="1" placeholder="MANDATORY: Explain why this is a significant risk..."/>
                        <group>
                            <field name="mandatory_substantive_required"/>
                            <field name="control_testing_permitted"/>
                            <field name="senior_involvement_required"/>
                            <field name="extended_procedures_required"/>
                        </group>
                        <field name="control_testing_justification" nolabel="1" placeholder="Required if control testing permitted..." 
                               invisible="not control_testing_permitted"/>
                    </group>
                    
                    <!-- Section E: Fraud Risk Details -->
                    <group string="Fraud Risk Details" invisible="not isa_240_fraud_risk">
                        <field name="fraud_type"/>
                        <field name="fraud_scenario_narrative" nolabel="1" placeholder="Describe specific fraud scenario..."/>
                    </group>
                    
                    <!-- Section F: Going Concern Details -->
                    <group string="Going Concern Risk Details" invisible="not isa_570_gc_risk">
                        <field name="gc_conditions_identified" nolabel="1" placeholder="Conditions/events casting doubt..."/>
                        <field name="gc_disclosure_impact" nolabel="1" placeholder="Required FS disclosures..."/>
                    </group>
                    
                    <!-- Section G: Controls Linkage -->
                    <group string="Internal Controls Linkage">
                        <group>
                            <field name="relevant_controls_identified"/>
                            <field name="control_reliance_planned"/>
                            <field name="control_reference_p3"/>
                        </group>
                        <field name="control_deficiency_impact" nolabel="1" placeholder="Impact of control deficiencies on RMM..."/>
                    </group>
                    
                    <group string="Planned Response">
                        <field name="planned_procedures" nolabel="1" placeholder="Document planned audit procedures..."/>
                    </group>
                    <group>
                        <group>
                            <field name="nature_of_procedures"/>
                            <field name="timing_of_procedures"/>
                        </group>
                        <group>
                            <field name="extent_of_procedures" nolabel="1" placeholder="Sample sizes, team member assignments..."/>
                            <field name="link_to_audit_program"/>
                        </group>
                    </group>
                </sheet>
            </form>
