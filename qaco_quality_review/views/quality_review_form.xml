<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        <record id="view_quality_review_tree" model="ir.ui.view">
        <field name="name">qaco.quality.review.tree</field>
        <field name="model">qaco.quality.review</field>
        <field name="arch" type="xml">
            <tree default_order="audit_id,name">
                <field name="name"/>
                <field name="audit_id"/>
                <field name="client_id"/>
                <field name="eqr_required" widget="boolean_toggle"/>
                <field name="eqr_partner_employee_id"/>
                <field name="overall_status" widget="badge" options="{'clickable': False}"/>
                <field name="open_review_note_count"/>
                <field name="open_finding_count"/>
                <field name="file_lock_date"/>
                <field name="archiving_completed"/>
            </tree>
        </field>
    </record>

    <record id="view_quality_review_search" model="ir.ui.view">
        <field name="name">qaco.quality.review.search</field>
        <field name="model">qaco.quality.review</field>
        <field name="arch" type="xml">
            <search string="Quality Reviews">
                <field name="audit_id"/>
                <field name="client_id" filter_domain="[('client_id', '=', self)]"/>
                <field name="eqr_partner_employee_id"/>
                <filter name="filter_eqr_required" string="EQR Mandatory" domain="[('eqr_required', '=', True)]"/>
                <filter name="filter_open_findings" string="Open Findings" domain="[('open_finding_count', '>', 0)]"/>
                <filter name="filter_open_notes" string="Open Review Notes" domain="[('open_review_note_count', '>', 0)]"/>
                <filter name="filter_not_locked" string="Unlock pending" domain="['|', ('file_lock_date', '=', False), ('archiving_completed', '=', False)]"/>
                <group expand="0" string="Group By">
                    <filter name="group_partner" string="EQR Partner" context="{'group_by': 'eqr_partner_employee_id'}"/>
                    <filter name="group_status" string="Status" context="{'group_by': 'overall_status'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="view_quality_review_form" model="ir.ui.view">
        <field name="name">qaco.quality.review.form</field>
        <field name="model">qaco.quality.review</field>
        <field name="arch" type="xml">
            <form string="Quality Review" create="0" class="o_planning_form">
                <header>
                    <button name="action_run_trigger_engine" type="object" string="Run Trigger Engine" class="oe_secondary"/>
                    <button name="action_finalize_eqr" type="object" string="Finalize EQR" class="oe_highlight" invisible="eqr_required == False or eqr_concluded == True"/>
                    <button name="action_validate_quality_gate" type="object" string="Validate Quality Gate" invisible="overall_status == 'green'"/>
                    <button name="action_lock_file" type="object" string="Lock File" invisible="file_lock_date != False"/>
                    <button name="action_mark_archived" type="object" string="Mark Archived" invisible="archiving_completed == True"/>
                    <field name="overall_status" widget="statusbar" statusbar_visible="red,amber,green"/>
                </header>
                <sheet class="o_planning_sheet">
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_validate_quality_gate">
                            <field name="quality_gate_passed" widget="boolean_button"/>
                            <span class="o_stat_text">Quality Gate</span>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_open_review_notes">
                            <field name="open_review_note_count" string="Review Notes" widget="statinfo"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_open_findings">
                            <field name="open_finding_count" string="Findings" widget="statinfo"/>
                        </button>
                        <!-- Session 7E: Planning Dashboard Button -->
                        <button name="action_open_planning_dashboard" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-dashboard"
                                help="Open planning phase dashboard">
                            <div class="o_stat_info">
                                <span class="o_stat_text">Planning</span>
                                <span class="o_stat_text">Dashboard</span>
                            </div>
                        </button>
                    </div>
                    <group>
                        <group>
                            <field name="name" readonly="1"/>
                            <field name="audit_id" readonly="1"/>
                            <field name="client_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="eqr_engine_reason" readonly="1" widget="text"/>
                            <field name="eqr_required" readonly="1"/>
                            <field name="trigger_status" widget="badge"/>
                            <field name="procedures_status" widget="badge"/>
                            <field name="monitoring_status" widget="badge"/>
                            <field name="locking_status" widget="badge"/>
                        </group>
                    </group>
                    <notebook class="o_planning_tabs">
                        <page name="section_61" string="6.1 - Triggers &amp; Scope" class="o_planning_tab_page">
                            <div id="section-6-1" class="o_onboarding_card">
                                <div class="o_onboarding_card_header">
                                    <span class="o_onboarding_card_number">6.1</span>
                                    <span class="o_onboarding_card_title">Triggers &amp; Scope</span>
                                    <span class="o_onboarding_card_ref">ISQM-1 / ISA 220</span>
                                </div>
                                <group class="o_phase_banner" colspan="2">
                                    <field name="trigger_status" widget="badge" options="{'clickable': False}"/>
                                    <div class="o_phase_banner_note">
                                        <strong>Trigger engine</strong><span> evaluates regulatory, independence, and risk signals.</span>
                                    </div>
                                </group>
                            <group>
                                <group>
                                    <field name="eqr_override_option"/>
                                    <field name="eqr_override_reason" required="eqr_override_option == 'force_off'"/>
                                </group>
                                <group>
                                    <field name="eqr_partner_employee_id"/>
                                    <field name="eqr_scope_definition" widget="html"/>
                                </group>
                            </group>
                            <field name="eqr_scope_line_ids" nolabel="1">
                                <tree editable="bottom" string="Scope Areas">
                                    <field name="sequence" widget="handle"/>
                                    <field name="focus_area"/>
                                    <field name="risk_rating"/>
                                    <field name="procedures" widget="html"/>
                                    <field name="status"/>
                                    <field name="reviewer_notes"/>
                                </tree>
                            </field>
                            <group string="Checklist ‚Äì Triggers" colspan="2">
                                <field name="checklist_line_ids" domain="[('checklist_type', '=', 'eqr_trigger')]" context="{'default_checklist_type': 'eqr_trigger'}" nolabel="1">
                                    <tree editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="question"/>
                                        <field name="blocking"/>
                                        <field name="response" widget="radio"/>
                                        <field name="comments"/>
                                    </tree>
                                </field>
                            </group>
                            </div>
                        </page>
                        <page name="section_62" string="6.2 - Procedures" class="o_planning_tab_page">
                            <div id="section-6-2" class="o_onboarding_card">
                                <div class="o_onboarding_card_header">
                                    <span class="o_onboarding_card_number">6.2</span>
                                    <span class="o_onboarding_card_title">Procedures &amp; Conclusion</span>
                                    <span class="o_onboarding_card_ref">ISQM-1 / ISA 220</span>
                                </div>
                                <group class="o_phase_banner" colspan="2">
                                    <field name="procedures_status" widget="badge" options="{'clickable': False}"/>
                                    <div class="o_phase_banner_note">
                                        <strong>Procedures</strong><span> need complete scope, judgments, and checklist validation.</span>
                                    </div>
                                </group>
                                <group>
                                    <group>
                                        <field name="significant_judgments_reviewed"/>
                                        <field name="financial_statements_eval"/>
                                    <field name="opinion_appropriate"/>
                                </group>
                                <group>
                                    <field name="kams_description_adequate"/>
                                    <field name="compliance_confirmed"/>
                                    <field name="eqr_concluded" readonly="1"/>
                                </group>
                            </group>
                            <group colspan="2">
                                <field name="eqr_review_note_ids" nolabel="1">
                                    <tree editable="bottom">
                                        <field name="reference"/>
                                        <field name="description"/>
                                        <field name="raised_by_id"/>
                                        <field name="assigned_to_id"/>
                                        <field name="status"/>
                                        <field name="cleared_on"/>
                                    </tree>
                                    <form string="Review Note">
                                        <sheet>
                                            <group>
                                                <field name="reference"/>
                                                <field name="status"/>
                                            </group>
                                            <group>
                                                <field name="raised_by_id"/>
                                                <field name="assigned_to_id"/>
                                            </group>
                                            <group>
                                                <field name="description"/>
                                                <field name="response"/>
                                                <field name="attachment_ids" widget="many2many_binary"/>
                                            </group>
                                        </sheet>
                                    </form>
                                </field>
                            </group>
                            <group>
                                <field name="eqr_conclusion_text" widget="html" colspan="2"/>
                                <field name="eqr_conclusion_attachment_ids" widget="many2many_binary"/>
                            </group>
                                <group string="Checklist ‚Äì Completion">
                                    <field name="checklist_line_ids" domain="[('checklist_type', '=', 'eqr_completion')]" context="{'default_checklist_type': 'eqr_completion'}" nolabel="1">
                                        <tree editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="question"/>
                                            <field name="blocking"/>
                                            <field name="response" widget="radio"/>
                                            <field name="comments"/>
                                        </tree>
                                    </field>
                                </group>
                            </div>
                        </page>
                        <page name="section_63" string="6.3 - Monitoring" class="o_planning_tab_page">
                            <div id="section-6-3" class="o_onboarding_card">
                                <div class="o_onboarding_card_header">
                                    <span class="o_onboarding_card_number">6.3</span>
                                    <span class="o_onboarding_card_title">Monitoring &amp; Findings</span>
                                    <span class="o_onboarding_card_ref">ISQM-1</span>
                                </div>
                                <group class="o_phase_banner" colspan="2">
                                    <field name="monitoring_status" widget="badge" options="{'clickable': False}"/>
                                    <div class="o_phase_banner_note">
                                        <strong>Monitoring</strong><span> tracks remediation progress and outstanding findings.</span>
                                    </div>
                                </group>
                                <group>
                                    <field name="monitoring_attachment_ids" widget="many2many_binary"/>
                                </group>
                                <group string="Checklist ‚Äì Remediation">
                                    <field name="checklist_line_ids" domain="[('checklist_type', '=', 'remediation')]" context="{'default_checklist_type': 'remediation'}" nolabel="1">
                                        <tree editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="question"/>
                                            <field name="response" widget="radio"/>
                                            <field name="comments"/>
                                        </tree>
                                    </field>
                                </group>
                                <field name="finding_ids" nolabel="1">
                                    <tree editable="bottom">
                                        <field name="source"/>
                                        <field name="description"/>
                                        <field name="severity"/>
                                        <field name="status"/>
                                        <field name="action_owner_id"/>
                                        <field name="due_date"/>
                                    </tree>
                                    <form string="Finding">
                                        <sheet>
                                            <group>
                                                <group>
                                                    <field name="source"/>
                                                    <field name="severity"/>
                                                    <field name="status"/>
                                                </group>
                                                <group>
                                                    <field name="action_owner_id"/>
                                                    <field name="due_date"/>
                                                    <field name="recurrence_flag"/>
                                                </group>
                                            <group colspan="2">
                                                <field name="description"/>
                                                <field name="root_cause_category"/>
                                                <field name="root_cause_notes"/>
                                            </group>
                                        </group>
                                        <group>
                                            <field name="attachment_ids" widget="many2many_binary"/>
                                            <field name="action_ids" nolabel="1">
                                                <tree editable="bottom">
                                                    <field name="task"/>
                                                    <field name="responsible_id"/>
                                                    <field name="due_date"/>
                                                    <field name="status"/>
                                                </tree>
                                            </field>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                            </div>
                        </page>
                        <page name="section_64" string="6.4 - Locking &amp; Archiving" class="o_planning_tab_page">
                            <div id="section-6-4" class="o_onboarding_card">
                                <div class="o_onboarding_card_header">
                                    <span class="o_onboarding_card_number">6.4</span>
                                    <span class="o_onboarding_card_title">Locking &amp; Archiving</span>
                                    <span class="o_onboarding_card_ref">ISA 230</span>
                                </div>
                                <group class="o_phase_banner" colspan="2">
                                    <field name="locking_status" widget="badge" options="{'clickable': False}"/>
                                    <div class="o_phase_banner_note">
                                        <strong>Locking</strong><span> verifies assembly, quality gate, and archive evidence.</span>
                                    </div>
                                </group>
                                <group>
                                    <group>
                                        <field name="file_completion_date"/>
                                        <field name="file_assembly_date"/>
                                        <field name="file_lock_date"/>
                                        <field name="file_lock_user_id" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="archiving_location"/>
                                        <field name="archiving_link" widget="url"/>
                                        <field name="retention_years"/>
                                        <field name="retention_expiry_date" readonly="1"/>
                                    </group>
                                </group>
                                <group>
                                    <field name="archiving_completed"/>
                                    <field name="archiving_completed_on" readonly="1"/>
                                </group>
                                <group>
                                    <field name="eqr_checklist_attachment_ids" widget="many2many_binary"/>
                                    <field name="file_lock_certificate_attachment_ids" widget="many2many_binary"/>
                                    <field name="archiving_evidence_attachment_ids" widget="many2many_binary"/>
                                </group>
                                <group string="Checklist ‚Äì Pre Lock">
                                    <field name="checklist_line_ids" domain="[('checklist_type', '=', 'pre_lock')]" context="{'default_checklist_type': 'pre_lock'}" nolabel="1">
                                        <tree editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="question"/>
                                            <field name="response" widget="radio"/>
                                            <field name="comments"/>
                                        </tree>
                                    </field>
                                </group>
                                <group string="Checklist ‚Äì Archiving">
                                    <field name="checklist_line_ids" domain="[('checklist_type', '=', 'archiving')]" context="{'default_checklist_type': 'archiving'}" nolabel="1">
                                        <tree editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="question"/>
                                            <field name="response" widget="radio"/>
                                            <field name="comments"/>
                                        </tree>
                                    </field>
                                </group>
                                <group>
                                    <field name="locking_alerts_html" widget="html" readonly="1" class="o_quality_lock_alerts"/>
                                </group>
                            </div>
                        </page>
                        
                        <!-- Session 7E: Planning Phase Integration Page -->
                        <page name="section_65_planning" string="6.5 - Planning Metrics" class="o_planning_tab_page">
                            <div id="section-6-5" class="o_onboarding_card">
                                <div class="o_onboarding_card_header">
                                    <span class="o_onboarding_card_number">6.5</span>
                                    <span class="o_onboarding_card_title">Planning Phase Review</span>
                                    <span class="o_onboarding_card_ref">ISA 300 / ISA 315</span>
                                </div>
                                <div class="alert alert-info" role="alert">
                                    <strong>üìä EQCR Focus:</strong> Review planning phase completeness and risk assessment quality.
                                    This section pulls metrics directly from the planning phase to support your quality control review.
                                </div>
                                
                                <!-- Planning Completion Metrics -->
                                <group string="Planning Phase Status">
                                    <group>
                                        <field name="planning_phase_id" readonly="1" 
                                               options="{'no_create': True, 'no_open': False}"/>
                                        <field name="planning_locked" widget="boolean" readonly="1"/>
                                        <field name="planning_completion_pct" widget="progressbar" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="planning_p6_risk_count" readonly="1"/>
                                        <field name="planning_significant_risk_count" readonly="1"/>
                                        <field name="planning_missing_approvals" readonly="1"/>
                                    </group>
                                </group>
                                
                                <!-- Red Flags Section -->
                                <group string="Planning Red Flags" class="o_planning_red_flags_section">
                                    <field name="planning_red_flags" widget="html" readonly="1" nolabel="1" colspan="2"/>
                                </group>
                                
                                <!-- EQCR Actions -->
                                <group string="EQCR Actions">
                                    <button name="action_open_planning_dashboard" 
                                            string="Open Planning Dashboard" 
                                            type="object" 
                                            class="btn-primary"
                                            help="View detailed planning phase progress and P-tab status"/>
                                    <button name="%(qaco_planning_phase.action_qaco_planning_phase)d" 
                                            string="View All Planning Records" 
                                            type="action" 
                                            class="btn-secondary"
                                            help="Open planning phase list view"/>
                                </group>
                                
                                <group string="EQCR Checklist - Planning Phase">
                                    <div class="alert alert-warning" role="alert">
                                        <strong>‚ö†Ô∏è Required Review:</strong> EQCR must verify that all planning tabs (P-1 through P-13) 
                                        are complete and approved before execution begins per ISA 300.
                                    </div>
                                    <field name="checklist_line_ids" domain="[('checklist_type', '=', 'eqr_completion')]" 
                                           context="{'default_checklist_type': 'eqr_completion'}" nolabel="1">
                                        <tree editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="question"/>
                                            <field name="response" widget="radio"/>
                                            <field name="comments"/>
                                        </tree>
                                    </field>
                                </group>
                            </div>
                        </page>
                        
                    </notebook>
                </sheet>
                <chatter>
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </chatter>
            </form>
        </field>
    </record>

    <record id="action_quality_review" model="ir.actions.act_window">
        <field name="name">Quality Reviews</field>
        <field name="res_model">qaco.quality.review</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_quality_review_search"/>
        <field name="view_id" ref="view_quality_review_tree"/>
        <field name="context">{'create': False}</field>
    </record>
    </data>
</odoo>
