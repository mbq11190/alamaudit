<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Execution Phase Form View -->
        <record id="view_execution_phase_form" model="ir.ui.view">
            <field name="name">qaco.execution.phase.form</field>
            <field name="model">qaco.execution.phase</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="action_start_fieldwork" string="Start Fieldwork" type="object" 
                                class="oe_highlight" invisible="state != 'draft'"/>
                        <button name="action_start_testing" string="Start Testing" type="object" 
                                class="oe_highlight" invisible="state != 'fieldwork'"/>
                        <button name="action_submit_review" string="Submit for Review" type="object" 
                                class="oe_highlight" invisible="state != 'testing'"/>
                        <button name="action_complete" string="Mark Complete" type="object" 
                                class="oe_highlight" invisible="state != 'review'"/>
                        <button name="action_back_to_draft" string="Back to Draft" type="object" 
                                invisible="state == 'draft'"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,fieldwork,testing,review,completed"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="client_name" readonly="1"/>
                            </h1>
                            <h3>
                                <span>Execution Phase - </span>
                                <field name="audit_year" widget="many2many_tags" readonly="1"/>
                            </h3>
                        </div>
                        
                        <group>
                            <group>
                                <field name="audit_id" invisible="1"/>
                                <field name="completion_percentage" widget="progressbar"/>
                                <field name="execution_lead"/>
                                <field name="fieldwork_start_date"/>
                                <field name="fieldwork_end_date"/>
                            </group>
                            <group>
                                <field name="fieldwork_location"/>
                                <field name="testing_category"/>
                                <field name="budgeted_hours"/>
                                <field name="actual_hours"/>
                                <field name="hours_variance" readonly="1"/>
                                <field name="hours_variance_percentage" readonly="1" widget="percentage"/>
                            </group>
                        </group>

                        <notebook>
                            <!-- Fieldwork Tab -->
                            <page string="Fieldwork Details" name="fieldwork">
                                <group>
                                    <group>
                                        <field name="fieldwork_address"/>
                                        <field name="client_contact_person"/>
                                        <field name="client_cooperation_level"/>
                                    </group>
                                    <group>
                                        <field name="access_issues"/>
                                        <field name="access_issues_description" invisible="not access_issues"/>
                                    </group>
                                </group>
                                <group string="Team Members">
                                    <field name="senior_auditors" widget="many2many_tags_avatar" nolabel="1"/>
                                    <field name="audit_assistants" widget="many2many_tags_avatar" nolabel="1"/>
                                </group>
                            </page>

                            <!-- Testing Procedures Tab -->
                            <page string="Testing &amp; Procedures" name="testing">
                                <group>
                                    <group string="Testing Progress">
                                        <field name="substantive_tests_completed"/>
                                        <field name="control_tests_completed"/>
                                        <field name="analytical_procedures_completed"/>
                                    </group>
                                    <group string="Sample Selection">
                                        <field name="sample_size"/>
                                        <field name="sample_selection_method"/>
                                    </group>
                                </group>
                                
                                <separator string="Testing Checklist"/>
                                <group>
                                    <group>
                                        <field name="test_cash_bank"/>
                                        <field name="test_receivables"/>
                                        <field name="test_inventory"/>
                                        <field name="test_fixed_assets"/>
                                        <field name="test_payables"/>
                                    </group>
                                    <group>
                                        <field name="test_revenue"/>
                                        <field name="test_expenses"/>
                                        <field name="test_payroll"/>
                                        <field name="test_tax"/>
                                        <field name="test_equity"/>
                                        <field name="test_other"/>
                                        <field name="test_other_description" invisible="not test_other"/>
                                    </group>
                                </group>
                                
                                <separator string="Testing Procedures"/>
                                <field name="testing_procedures" widget="html"/>
                                
                                <separator string="Sample Selection Notes"/>
                                <field name="sample_notes"/>
                            </page>

                            <!-- Evidence Tab -->
                            <page string="Evidence Collection" name="evidence">
                                <group>
                                    <group>
                                        <field name="evidence_obtained" readonly="1"/>
                                        <field name="evidence_quality"/>
                                    </group>
                                    <group>
                                        <field name="currency_id" invisible="1"/>
                                    </group>
                                </group>
                                <separator string="Evidence Collection Notes"/>
                                <field name="evidence_notes" widget="html"/>
                            </page>

                            <!-- Findings Tab -->
                            <page string="Findings &amp; Observations" name="findings">
                                <group>
                                    <group>
                                        <field name="findings_count" readonly="1"/>
                                        <field name="misstatements_identified"/>
                                    </group>
                                    <group>
                                        <field name="misstatement_amount" invisible="not misstatements_identified"/>
                                    </group>
                                </group>
                                
                                <separator string="Significant Findings"/>
                                <field name="significant_findings" widget="html"/>
                                
                                <separator string="Control Deficiencies"/>
                                <field name="control_deficiencies" widget="html"/>
                            </page>

                            <!-- Working Papers Tab -->
                            <page string="Working Papers &amp; Review" name="working_papers">
                                <group>
                                    <group string="Working Papers Status">
                                        <field name="working_papers_complete"/>
                                        <field name="working_papers_reviewed"/>
                                    </group>
                                    <group string="Review Details">
                                        <field name="reviewer_id"/>
                                        <field name="review_date"/>
                                    </group>
                                </group>
                                
                                <separator string="Review Notes"/>
                                <field name="review_notes" widget="html"/>
                            </page>

                            <!-- Documentation Tab -->
                            <page string="Documentation &amp; Notes" name="documentation">
                                <separator string="Execution Notes"/>
                                <field name="execution_notes" widget="html"/>
                                
                                <separator string="Attachments (Working Papers, Evidence, etc.)"/>
                                <field name="execution_attachments" widget="many2many_binary"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Execution Phase Tree View -->
        <record id="view_execution_phase_tree" model="ir.ui.view">
            <field name="name">qaco.execution.phase.tree</field>
            <field name="model">qaco.execution.phase</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="audit_id"/>
                    <field name="client_name"/>
                    <field name="execution_lead"/>
                    <field name="fieldwork_start_date"/>
                    <field name="fieldwork_end_date"/>
                    <field name="completion_percentage" widget="progressbar"/>
                    <field name="state" widget="badge" decoration-info="state == 'draft'" 
                           decoration-primary="state == 'fieldwork'" decoration-warning="state == 'testing'"
                           decoration-success="state == 'completed'"/>
                </tree>
            </field>
        </record>

        <!-- Execution Phase Search View -->
        <record id="view_execution_phase_search" model="ir.ui.view">
            <field name="name">qaco.execution.phase.search</field>
            <field name="model">qaco.execution.phase</field>
            <field name="arch" type="xml">
                <search>
                    <field name="audit_id"/>
                    <field name="client_name"/>
                    <field name="execution_lead"/>
                    <separator/>
                    <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="In Fieldwork" name="fieldwork" domain="[('state', '=', 'fieldwork')]"/>
                    <filter string="Testing" name="testing" domain="[('state', '=', 'testing')]"/>
                    <filter string="Under Review" name="review" domain="[('state', '=', 'review')]"/>
                    <filter string="Completed" name="completed" domain="[('state', '=', 'completed')]"/>
                    <group expand="0" string="Group By">
                        <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Execution Lead" name="group_lead" context="{'group_by': 'execution_lead'}"/>
                        <filter string="Audit" name="group_audit" context="{'group_by': 'audit_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Execution Phase Action -->
        <record id="action_execution_phase" model="ir.actions.act_window">
            <field name="name">Execution Phase</field>
            <field name="res_model">qaco.execution.phase</field>
            <field name="view_mode">tree,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first Execution Phase
                </p>
                <p>
                    Manage audit execution including fieldwork, testing, evidence collection, and findings.
                </p>
            </field>
        </record>
    </data>
</odoo>
