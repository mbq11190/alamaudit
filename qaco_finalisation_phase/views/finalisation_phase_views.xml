<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Finalisation Phase Form View -->
        <record id="view_finalisation_phase_form" model="ir.ui.view">
            <field name="name">qaco.finalisation.phase.form</field>
            <field name="model">qaco.finalisation.phase</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="action_start_drafting" string="Start Drafting" type="object" 
                                class="oe_highlight" invisible="state != 'draft'"/>
                        <button name="action_submit_review" string="Submit for Review" type="object" 
                                class="oe_highlight" invisible="state != 'report_drafting'"/>
                        <button name="action_submit_qc" string="Submit to QC" type="object" 
                                class="oe_highlight" invisible="state != 'review'"/>
                        <button name="action_client_discussion" string="Client Discussion" type="object" 
                                class="oe_highlight" invisible="state != 'qc_review'"/>
                        <button name="action_awaiting_signoff" string="Awaiting Sign-off" type="object" 
                                class="oe_highlight" invisible="state != 'client_discussion'"/>
                        <button name="action_complete" string="Mark Complete" type="object" 
                                class="oe_highlight" invisible="state != 'signoff'"/>
                        <button name="action_archive_file" string="Archive File" type="object" 
                                invisible="state != 'completed'"/>
                        <button name="action_back_to_draft" string="Back to Draft" type="object" 
                                invisible="state == 'draft'"/>
                        <field name="state" widget="statusbar" 
                               statusbar_visible="draft,report_drafting,review,qc_review,client_discussion,signoff,completed"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="client_name" readonly="1"/>
                            </h1>
                            <h3>
                                <span>Finalisation Phase - </span>
                                <field name="audit_year" widget="many2many_tags" readonly="1"/>
                            </h3>
                        </div>
                        
                        <group>
                            <group>
                                <field name="audit_id" invisible="1"/>
                                <field name="completion_percentage" widget="progressbar"/>
                                <field name="report_type"/>
                                <field name="report_opinion"/>
                                <field name="report_issued_date"/>
                            </group>
                            <group>
                                <field name="partner_signoff"/>
                                <field name="partner_signoff_name" invisible="not partner_signoff"/>
                                <field name="partner_signoff_date" invisible="not partner_signoff"/>
                                <field name="audit_file_complete"/>
                                <field name="file_archived"/>
                            </group>
                        </group>

                        <notebook>
                            <!-- Report Details Tab -->
                            <page string="Report Details" name="report">
                                <group>
                                    <group string="Report Dates">
                                        <field name="report_draft_date"/>
                                        <field name="report_final_date"/>
                                    </group>
                                    <group string="Report Opinion">
                                        <field name="emphasis_of_matter"/>
                                        <field name="other_matter"/>
                                    </group>
                                </group>
                                
                                <separator string="Emphasis of Matter" invisible="not emphasis_of_matter"/>
                                <field name="emphasis_of_matter_description" widget="html" 
                                       invisible="not emphasis_of_matter"/>
                                
                                <separator string="Other Matter" invisible="not other_matter"/>
                                <field name="other_matter_description" widget="html" 
                                       invisible="not other_matter"/>
                                
                                <separator string="Key Audit Matters (KAM)"/>
                                <field name="key_audit_matters" widget="html"/>
                            </page>

                            <!-- Review Process Tab -->
                            <page string="Review Process" name="review_process">
                                <group>
                                    <group string="Report Preparation">
                                        <field name="draft_prepared_by"/>
                                    </group>
                                </group>
                                
                                <group>
                                    <group string="First Review (Manager)">
                                        <field name="first_reviewer"/>
                                        <field name="first_review_date"/>
                                        <field name="first_review_completed"/>
                                    </group>
                                    <group string="Second Review (Partner)">
                                        <field name="second_reviewer"/>
                                        <field name="second_review_date"/>
                                        <field name="second_review_completed"/>
                                    </group>
                                </group>
                                
                                <separator string="Quality Control Review"/>
                                <group>
                                    <group>
                                        <field name="quality_control_reviewer"/>
                                        <field name="quality_control_date"/>
                                        <field name="quality_control_completed"/>
                                    </group>
                                </group>
                                <field name="quality_control_notes" widget="html"/>
                            </page>

                            <!-- Adjustments Tab -->
                            <page string="Adjustments" name="adjustments">
                                <group>
                                    <group>
                                        <field name="adjustments_proposed"/>
                                        <field name="currency_id" invisible="1"/>
                                        <field name="total_adjustment_amount" invisible="not adjustments_proposed"/>
                                    </group>
                                </group>
                                
                                <separator string="Passed Adjustments" invisible="not adjustments_proposed"/>
                                <field name="passed_adjustments" widget="html" invisible="not adjustments_proposed"/>
                                
                                <separator string="Waived Adjustments" invisible="not adjustments_proposed"/>
                                <field name="waived_adjustments" widget="html" invisible="not adjustments_proposed"/>
                            </page>

                            <!-- Client Discussion Tab -->
                            <page string="Client Discussion" name="client_discussion">
                                <group>
                                    <group>
                                        <field name="exit_meeting_date"/>
                                    </group>
                                </group>
                                
                                <separator string="Exit Meeting Attendees"/>
                                <field name="exit_meeting_attendees"/>
                                
                                <separator string="Client Concerns/Questions"/>
                                <field name="client_concerns" widget="html"/>
                                
                                <separator string="Responses Provided"/>
                                <field name="client_responses" widget="html"/>
                            </page>

                            <!-- Management Rep & Going Concern Tab -->
                            <page string="Management Rep &amp; Going Concern" name="management_rep">
                                <group string="Management Representation Letter">
                                    <group>
                                        <field name="representation_letter_received"/>
                                        <field name="representation_letter_date" invisible="not representation_letter_received"/>
                                    </group>
                                    <group>
                                        <field name="representation_letter_signatory" invisible="not representation_letter_received"/>
                                        <field name="representation_letter_title" invisible="not representation_letter_received"/>
                                    </group>
                                </group>
                                
                                <group string="Subsequent Events">
                                    <group>
                                        <field name="subsequent_events_review"/>
                                        <field name="subsequent_events_date" invisible="not subsequent_events_review"/>
                                    </group>
                                </group>
                                <field name="subsequent_events_notes" widget="html" invisible="not subsequent_events_review"/>
                                
                                <separator string="Going Concern Assessment"/>
                                <group>
                                    <field name="going_concern_assessment" nolabel="1"/>
                                </group>
                                <field name="going_concern_notes" widget="html"/>
                            </page>

                            <!-- Deliverables Tab -->
                            <page string="Deliverables" name="deliverables">
                                <separator string="Final Audit Report"/>
                                <field name="audit_report_final" widget="many2many_binary"/>
                                
                                <separator string="Management Letter"/>
                                <field name="management_letter" widget="many2many_binary"/>
                                
                                <separator string="Audited Financial Statements"/>
                                <field name="financial_statements" widget="many2many_binary"/>
                                
                                <separator string="Other Deliverables"/>
                                <field name="other_deliverables" widget="many2many_binary"/>
                            </page>

                            <!-- Independence & Checklist Tab -->
                            <page string="Independence &amp; Completion" name="independence">
                                <group string="Independence Confirmation">
                                    <group>
                                        <field name="independence_confirmed"/>
                                        <field name="independence_confirmation_date" invisible="not independence_confirmed"/>
                                    </group>
                                </group>
                                <field name="independence_notes" invisible="not independence_confirmed"/>
                                
                                <separator string="Completion Checklist"/>
                                <group>
                                    <group>
                                        <field name="checklist_workpapers_reviewed"/>
                                        <field name="checklist_conclusions_documented"/>
                                        <field name="checklist_differences_resolved"/>
                                        <field name="checklist_schedules_complete"/>
                                    </group>
                                    <group>
                                        <field name="checklist_cross_references"/>
                                        <field name="checklist_supervision_documented"/>
                                        <field name="checklist_compliance_verified"/>
                                        <field name="checklist_all_complete" readonly="1" widget="boolean"/>
                                    </group>
                                </group>
                            </page>

                            <!-- File Archival Tab -->
                            <page string="File Archival" name="archival">
                                <group>
                                    <group string="File Completion">
                                        <field name="file_assembly_deadline"/>
                                        <field name="file_completion_date"/>
                                    </group>
                                    <group string="Archival">
                                        <field name="file_archive_location"/>
                                    </group>
                                </group>
                                
                                <group string="Retention">
                                    <group>
                                        <field name="retention_period_years"/>
                                        <field name="destruction_date" readonly="1"/>
                                    </group>
                                </group>
                            </page>

                            <!-- Notes & Attachments Tab -->
                            <page string="Notes &amp; Attachments" name="notes">
                                <separator string="Finalisation Notes"/>
                                <field name="finalisation_notes" widget="html"/>
                                
                                <separator string="Additional Attachments"/>
                                <field name="finalisation_attachments" widget="many2many_binary"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Finalisation Phase Tree View -->
        <record id="view_finalisation_phase_tree" model="ir.ui.view">
            <field name="name">qaco.finalisation.phase.tree</field>
            <field name="model">qaco.finalisation.phase</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="audit_id"/>
                    <field name="client_name"/>
                    <field name="report_type"/>
                    <field name="report_opinion" widget="badge"/>
                    <field name="partner_signoff_name"/>
                    <field name="report_issued_date"/>
                    <field name="completion_percentage" widget="progressbar"/>
                    <field name="state" widget="badge" decoration-info="state == 'draft'" 
                           decoration-primary="state in ['report_drafting', 'review']" 
                           decoration-warning="state in ['qc_review', 'client_discussion', 'signoff']"
                           decoration-success="state == 'completed'" decoration-muted="state == 'archived'"/>
                </tree>
            </field>
        </record>

        <!-- Finalisation Phase Search View -->
        <record id="view_finalisation_phase_search" model="ir.ui.view">
            <field name="name">qaco.finalisation.phase.search</field>
            <field name="model">qaco.finalisation.phase</field>
            <field name="arch" type="xml">
                <search>
                    <field name="audit_id"/>
                    <field name="client_name"/>
                    <field name="partner_signoff_name"/>
                    <separator/>
                    <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Drafting" name="drafting" domain="[('state', '=', 'report_drafting')]"/>
                    <filter string="Review" name="review" domain="[('state', '=', 'review')]"/>
                    <filter string="QC Review" name="qc" domain="[('state', '=', 'qc_review')]"/>
                    <filter string="Client Discussion" name="client" domain="[('state', '=', 'client_discussion')]"/>
                    <filter string="Sign-off" name="signoff" domain="[('state', '=', 'signoff')]"/>
                    <filter string="Completed" name="completed" domain="[('state', '=', 'completed')]"/>
                    <filter string="Archived" name="archived" domain="[('state', '=', 'archived')]"/>
                    <separator/>
                    <filter string="Partner Signed-off" name="partner_signed" domain="[('partner_signoff', '=', True)]"/>
                    <filter string="File Archived" name="file_archived" domain="[('file_archived', '=', True)]"/>
                    <group expand="0" string="Group By">
                        <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Report Opinion" name="group_opinion" context="{'group_by': 'report_opinion'}"/>
                        <filter string="Signing Partner" name="group_partner" context="{'group_by': 'partner_signoff_name'}"/>
                        <filter string="Audit" name="group_audit" context="{'group_by': 'audit_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Finalisation Phase Action -->
        <record id="action_finalisation_phase" model="ir.actions.act_window">
            <field name="name">Finalisation Phase</field>
            <field name="res_model">qaco.finalisation.phase</field>
            <field name="view_mode">tree,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first Finalisation Phase
                </p>
                <p>
                    Manage audit finalisation including report drafting, reviews, client discussions, and sign-off.
                </p>
            </field>
        </record>
    </data>
</odoo>
